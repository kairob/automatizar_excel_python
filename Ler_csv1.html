<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitura Automática de CSV</title>
</head>
<body>
    <label for="csvFiles">Selecione arquivos CSV:</label>
    <input type="file" id="csvFiles" accept=".csv" multiple title="Selecione um ou mais arquivos CSV">
    <div id="distritosContainer"></div> <!-- Container para exibir distritos com valores -->

    <script>
        let dataArray = [];

        document.getElementById('csvFiles').addEventListener('change', processCSV);

        function processCSV() {
            const fileInput = document.getElementById('csvFiles');
            const files = fileInput.files;

            if (files.length === 0) return;

            const promises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const text = e.target.result;
                            let rows = text.split(/\r?\n/).map(row => row.split(",").map(cell => sanitizeText(cell)));

                            if (rows.length === 0 || rows[0].length === 0) {
                                throw new Error("Arquivo CSV vazio ou inválido.");
                            }

                            rows = rows.map(row => ({
                                id: parseInt(row[0].trim(), 10),
                                valores: row.slice(1)
                            }));

                            resolve(rows);
                        } catch (error) {
                            console.error("Erro ao processar CSV:", error);
                            reject(error);
                        }
                    };
                    reader.onerror = () => {
                        console.error("Erro ao ler arquivo:", file.name);
                        reject(new Error(`Erro ao ler o arquivo ${file.name}.`));
                    };
                    reader.readAsText(file);
                });
            });

            Promise.all(promises)
                .then(results => {
                    dataArray = results.flat();
                    integrateData();
                    mostrarDistritosNaTela(); // Exibir distritos com valores na tela
                })
                .catch(error => console.error("Erro ao carregar arquivos:", error));
        }

        const dados_dist = [
            { "ID": 4301000, "DISTRITO": 301 },
            { "ID": 4301004, "DISTRITO": 301 },
            { "ID": 4301006, "DISTRITO": 301 },
            { "ID": 4301010, "DISTRITO": 301 },
            { "ID": 4301011, "DISTRITO": 301 },
            { "ID": 4302000, "DISTRITO": 301 },
            { "ID": 4302010, "DISTRITO": 301 },
            { "ID": 4302020, "DISTRITO": 301 },
            { "ID": 4302030, "DISTRITO": 301 },
            { "ID": 4302040, "DISTRITO": 301 },
            { "ID": 4302050, "DISTRITO": 301 },
            { "ID": 4303000, "DISTRITO": 302 },
            { "ID": 4303040, "DISTRITO": 302 },
            { "ID": 4303080, "DISTRITO": 302 },
            { "ID": 4303090, "DISTRITO": 302 }
        ];

        function integrateData() {
            dataArray = dataArray.map(row => {
                let distritoEncontrado = dados_dist.find(d => d.ID === row.id);
                return {
                    id: row.id,
                    distrito: distritoEncontrado ? distritoEncontrado.DISTRITO : "N/A",
                    valores: row.valores
                };
            });
        }

        function mostrarDistritosNaTela() {
            console.log("Exibindo distritos com valores...");

            const distritos = dataArray.map(row => ({
                distrito: row.distrito,
                valores: [...new Set(row.valores)] // Removendo duplicatas apenas nos valores
            }));

            const container = document.getElementById("distritosContainer");

            if (!container) {
                console.error("Elemento #distritosContainer não encontrado!");
                return;
            }

            container.innerHTML = ""; // Limpa antes de exibir

            let titulo = document.createElement("h2");
            titulo.textContent = "Lista de Distritos com Valores";
            container.appendChild(titulo);

            let table = document.createElement("table");
            table.border = "1";

            let headerRow = document.createElement("tr");
            headerRow.innerHTML = `<th>DISTRITO</th><th>Valores</th>`;
            table.appendChild(headerRow);

            if (distritos.length === 0) {
                let rowElement = document.createElement("tr");
                rowElement.innerHTML = `<td colspan="2">Nenhum distrito encontrado</td>`;
                table.appendChild(rowElement);
            } else {
                distritos.forEach(row => {
                    let rowElement = document.createElement("tr");
                    rowElement.innerHTML = `<td>${row.distrito}</td><td>${row.valores.join(", ")}</td>`;
                    table.appendChild(rowElement);
                });
            }

            container.appendChild(table);
            console.log("Distritos e valores exibidos na tela!");
        }

        function sanitizeText(text) {
            return text.trim()
                .replace(/\s{2,}/g, " ")
                .replace(/(\w)\1{2,}/g, "$1$1");
        }
    </script>
</body>
</html>