<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Filtrar Distritos Dinâmicos</title>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body>
    <h2>Filtrar Distritos Separadamente</h2>
    <label for="csvFile">Selecione um arquivo CSV:</label>
    <input type="file" id="csvFile" accept=".csv" />
    <br><br>
    
    <div id="districtsList"></div>
    <div id="tablesContainer"></div>

    <script>
        function parseCSV(text) {
            return text.split('\n').map(row => row.split(',').map(col => col.trim()));
        }

        function removeDuplicateLogradouro(data) {
            const seenLogradouros = new Set();
            return data.filter(item => {
                if (seenLogradouros.has(item.logradouro)) {
                    return false;
                }
                seenLogradouros.add(item.logradouro);
                return true;
            });
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = parseCSV(text);

                console.log("Cabeçalhos detectados:", rows[0]);

                const idIndex = rows[0].findIndex(col => col.toLowerCase() === 'id');
                const logradouroIndex = rows[0].findIndex(col => col.toLowerCase() === 'logradouro');

                if (idIndex === -1 || logradouroIndex === -1) {
                    console.error('Colunas ID ou LOGRADOURO não encontradas no CSV!');
                    return;
                }

                let csvData = rows.slice(1).map(row => ({
                    id: row[idIndex],
                    logradouro: row[logradouroIndex]
                })).filter(item => item.id && item.logradouro);

                fetch('csvjson.json')
                    .then(response => response.json())
                    .then(jsonData => {
                        const filteredData = csvData.map(csvItem => {
                            const match = jsonData.find(jsonItem => String(jsonItem.ID) === csvItem.id);
                            return {
                                id: csvItem.id,
                                logradouro: csvItem.logradouro,
                                distrito: match ? match.DISTRITO : 'Outro'
                            };
                        });

                        const uniqueData = removeDuplicateLogradouro(filteredData);
                        
                        let distritos = {};
                        let contagemDistritos = {};

                        uniqueData.forEach(item => {
                            const distritoCategoria = `Distrito ${item.distrito}`;
                            
                            if (!distritos[distritoCategoria]) {
                                distritos[distritoCategoria] = [];
                                contagemDistritos[distritoCategoria] = 0;
                            }
                            distritos[distritoCategoria].push(item);
                            contagemDistritos[distritoCategoria]++;
                        });

                        let districtButtons = "<h3>Distritos</h3>";
                        for (const [distrito, count] of Object.entries(contagemDistritos)) {
                            districtButtons += `<button onclick="showDistrict('${distrito}')">${distrito} - Total: ${count}</button><br>`;
                        }

                        document.getElementById('districtsList').innerHTML = districtButtons;

                        let html = "";
                        for (const [distrito, dados] of Object.entries(distritos)) {
                            html += `<div id="${distrito}" class="hidden"><h3>${distrito} - Total: ${contagemDistritos[distrito]}</h3>`;
                            html += '<table border="1"><tr><th>ID</th><th>Logradouro</th><th>Distrito</th></tr>';
                            dados.forEach(item => {
                                html += `<tr><td>${item.id}</td><td>${item.logradouro}</td><td>${item.distrito}</td></tr>`;
                            });
                            html += '</table><br></div>';
                        }

                        document.getElementById('tablesContainer').innerHTML = html;
                    })
                    .catch(error => console.error('Erro ao carregar JSON:', error));
            };

            reader.readAsText(file);
        });

        function showDistrict(districtId) {
            document.querySelectorAll('.hidden').forEach(el => el.style.display = 'none');
            document.getElementById(districtId).style.display = 'block';
        }
    </script>
</body>
</html>