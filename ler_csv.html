<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitura Autom√°tica de CSV</title>
</head>
<body>
    <label for="csvFiles">Selecione arquivos CSV:</label>
    <input type="file" id="csvFiles" accept=".csv" multiple title="Selecione um ou mais arquivos CSV">
    <button onclick="downloadUpdatedCSV()">Baixar CSV Atualizado</button>
    <table border="1" id="csvTable"></table>

    <script>
        let csvAssociado = []; // Novo array com dados do CSV e coluna de distrito

        document.getElementById('csvFiles').addEventListener('change', processCSV);

        function processCSV() {
            const fileInput = document.getElementById('csvFiles');
            const files = fileInput.files;

            if (files.length === 0) return;

            const promises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const text = e.target.result;
                        let rows = text.split("\n").map(row => row.split(","));

                        csvAssociado = rows.map(row => {
                            let id = parseInt(row[0].trim());
                            let distritoEncontrado = dados_dist.find(d => d.ID === id);
                            
                            return {
                                id: id,
                                distrito: distritoEncontrado ? distritoEncontrado.DISTRITO : "N/A",
                                valores: row.slice(1).map(cell => sanitizeText(cell))
                            };
                        });

                        updateTable();
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            });

            Promise.all(promises).catch(error => console.error("Erro ao carregar arquivos:", error));
        }

        const dados_dist = [ 
            { "ID": 4618000, "DISTRITO": 319 }, { "ID": 4618001, "DISTRITO": 319 }, 
            { "ID": 4618002, "DISTRITO": 319 }, { "ID": 4618003, "DISTRITO": 319 }
        ]; // Exemplo reduzido

        function updateTable() {
            const table = document.getElementById("csvTable");
            table.innerHTML = "";

            let headerRow = document.createElement("tr");
            headerRow.innerHTML = "<th>ID</th><th>DISTRITO</th><th>Valores</th>";
            table.appendChild(headerRow);

            csvAssociado.forEach(row => {
                let rowElement = document.createElement("tr");
                rowElement.innerHTML = `<td>${row.id}</td><td>${row.distrito}</td><td>${row.valores.join(", ")}</td>`;
                table.appendChild(rowElement);
            });
        }

        function sanitizeText(text) {
            return text.trim().replace(/\s{2,}/g, " ").replace(/(\w)\1{2,}/g, "$1$1");
        }

        function downloadUpdatedCSV() {
            if (csvAssociado.length === 0) {
                alert("Nenhum dado para salvar.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,DISTRITO,Valores\n";

            csvAssociado.forEach(row => {
                let line = row.id + "," + row.distrito + "," + row.valores.join(",");
                csvContent += line + "\n";
            });

            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "dados_associados.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>